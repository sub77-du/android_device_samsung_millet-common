From 54591c0358d860b5be1d9bd86b94fb395ad78508 Mon Sep 17 00:00:00 2001
From: sub77 <sub77@ymail.com>
Date: Wed, 9 Mar 2016 22:34:57 -0600
Subject: [PATCH] vold: Native exfat driver support - fixed

Change-Id: I64da1c13ed3e9cf7ea7e133c5757ab91810cbf1b
---
 Android.mk   |  4 ++++
 fs/Exfat.cpp | 12 ++++++++++++
 2 files changed, 16 insertions(+)

diff --git a/Android.mk b/Android.mk
index ce69f3e..51eadb7 100644
--- a/Android.mk
+++ b/Android.mk
@@ -70,6 +70,10 @@ common_static_libraries := \
 vold_conlyflags := -std=c11
 vold_cflags := -Werror -Wall -Wno-missing-field-initializers -Wno-unused-variable -Wno-unused-parameter
 
+ifeq ($(TARGET_KERNEL_HAVE_EXFAT),true)
+vold_cflags += -DCONFIG_KERNEL_HAVE_EXFAT
+endif
+
 include $(CLEAR_VARS)
 
 LOCAL_ADDITIONAL_DEPENDENCIES := $(LOCAL_PATH)/Android.mk
diff --git a/fs/Exfat.cpp b/fs/Exfat.cpp
index 24a7831..7cfb019 100644
--- a/fs/Exfat.cpp
+++ b/fs/Exfat.cpp
@@ -33,7 +33,11 @@ namespace exfat {
 
 static const char* kMkfsPath = "/system/bin/mkfs.exfat";
 static const char* kFsckPath = "/system/bin/fsck.exfat";
+#ifdef CONFIG_KERNEL_HAVE_EXFAT
+static const char* kMountPath = "/system/bin/mount";
+#else
 static const char* kMountPath = "/system/bin/mount.exfat";
+#endif
 
 bool IsSupported() {
     return access(kMkfsPath, X_OK) == 0
@@ -58,13 +62,21 @@ status_t Mount(const std::string& source, const std::string& target, bool ro,
     const char* c_target = target.c_str();
 
     sprintf(mountData,
+#ifdef CONFIG_KERNEL_HAVE_EXFAT
+            "noatime,nodev,nosuid,uid=%d,gid=%d,fmask=%o,dmask=%o,%s,%s",
+#else
             "noatime,nodev,nosuid,dirsync,uid=%d,gid=%d,fmask=%o,dmask=%o,%s,%s",
+#endif
             ownerUid, ownerGid, permMask, permMask,
             (executable ? "exec" : "noexec"),
             (ro ? "ro" : "rw"));
 
     std::vector<std::string> cmd;
     cmd.push_back(kMountPath);
+#ifdef CONFIG_KERNEL_HAVE_EXFAT
+    cmd.push_back("-t");
+    cmd.push_back("exfat");
+#endif
     cmd.push_back("-o");
     cmd.push_back(mountData);
     cmd.push_back(c_source);
-- 
1.9.1

