From ba34ab45de364217968ebe1d170e8094bfbf14f6 Mon Sep 17 00:00:00 2001
From: dhacker29 <dhackerdvm@gmail.com>
Date: Sun, 6 Dec 2015 05:32:30 -0500
Subject: [PATCH 4/4] vold: Native NTFS kernel driver support

Change-Id: I825b2840a03e5cdab9b68f13fd5170acbbcec2e5
---
 Android.mk  |  4 ++++
 fs/Ntfs.cpp | 12 ++++++++++++
 2 files changed, 16 insertions(+)

diff --git a/Android.mk b/Android.mk
index 51eadb7..2c0aebc 100644
--- a/Android.mk
+++ b/Android.mk
@@ -74,6 +74,10 @@ ifeq ($(TARGET_KERNEL_HAVE_EXFAT),true)
 vold_cflags += -DCONFIG_KERNEL_HAVE_EXFAT
 endif
 
+ifeq ($(TARGET_KERNEL_HAVE_NTFS),true)
+vold_cflags += -DCONFIG_KERNEL_HAVE_NTFS
+endif
+
 include $(CLEAR_VARS)
 
 LOCAL_ADDITIONAL_DEPENDENCIES := $(LOCAL_PATH)/Android.mk
diff --git a/fs/Ntfs.cpp b/fs/Ntfs.cpp
index a6663f8..55c17e5 100644
--- a/fs/Ntfs.cpp
+++ b/fs/Ntfs.cpp
@@ -33,7 +33,11 @@ namespace ntfs {
 
 static const char* kMkfsPath = "/system/bin/mkfs.ntfs";
 static const char* kFsckPath = "/system/bin/fsck.ntfs";
+#ifdef CONFIG_KERNEL_HAVE_NTFS
+static const char* kMountPath = "/system/bin/mount";
+#else
 static const char* kMountPath = "/system/bin/mount.ntfs";
+#endif
 
 bool IsSupported() {
     return access(kMkfsPath, X_OK) == 0
@@ -61,8 +65,12 @@ status_t Mount(const std::string& source, const std::string& target, bool ro,
     const char* c_target = target.c_str();
 
     sprintf(mountData,
+#ifdef CONFIG_KERNEL_HAVE_NTFS
+            "utf8,uid=%d,gid=%d,fmask=%o,dmask=%o,nodev,nosuid",
+#else
             "utf8,uid=%d,gid=%d,fmask=%o,dmask=%o,"
             "shortname=mixed,nodev,nosuid,dirsync",
+#endif
             ownerUid, ownerGid, permMask, permMask);
 
     if (!executable)
@@ -74,6 +82,10 @@ status_t Mount(const std::string& source, const std::string& target, bool ro,
 
     std::vector<std::string> cmd;
     cmd.push_back(kMountPath);
+#ifdef CONFIG_KERNEL_HAVE_NTFS
+    cmd.push_back("-t");
+    cmd.push_back("ntfs");
+#endif
     cmd.push_back("-o");
     cmd.push_back(mountData);
     cmd.push_back(c_source);
-- 
1.9.1

